name: Notify Homebrew Tap

on:
  release:
    types: [published]

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR already exists in tap (guard)
        id: guard
        env:
          TAG: ${{ github.event.release.tag_name }}
          TOKEN: ${{ secrets.HOMEBREW_RONA_TOKEN }}
        run: |
          OWNER="rona-rs"
          REPO="homebrew-rona"
          HEAD="${OWNER}:bump/rona-${TAG}"
          # Query open PRs with the expected head branch
          RES=$(curl -s -H "Authorization: token ${TOKEN}" \
            "https://api.github.com/repos/${OWNER}/${REPO}/pulls?state=open&head=${HEAD}")
          COUNT=$(echo "$RES" | jq 'length')
          if [ "$COUNT" -gt 0 ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Found existing PR for ${HEAD}, skipping dispatch"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No existing PR for ${HEAD}, will dispatch"
          fi

      - name: Dispatch update to homebrew-rona
        if: steps.guard.outputs.exists == 'false'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.HOMEBREW_RONA_TOKEN }}
          repository: rona-rs/homebrew-rona
          event-type: rona-release
          client-payload: |
            {
              "tag": "${{ github.event.release.tag_name }}",
              "tarball_url": "https://github.com/rona-rs/rona/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz"
            }
